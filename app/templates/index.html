<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Go2 Robot Control</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
</head>
<body>
    <header>
        <div class="brand">
            <div class="logo">ü§ñ</div>
            <span>Go2 Control Panel</span>
        </div>
        <div class="theme-switch">
            <input type="checkbox" id="theme-toggle" />
            <label for="theme-toggle" class="slider"></label>
        </div>
        <div class="robot-status-header">
            <span id="header-state">√âtat : <span id="header-state-val">...</span></span>
            <span id="header-battery">üîã <span id="header-battery-val">...</span>%</span>
        </div>
    </header>
    <nav>
        <ul>
            <li><a href="#intro">Introduction</a></li>
            <li class="active"><a href="#control">Contr√¥le</a></li>
            <li><a href="#map-section">Carte</a></li>
            <li><a href="#video">Vid√©o</a></li>
            <li><a href="#doc-archi">Documentation</a></li>
        </ul>
    </nav>
    <main>
        <div class="container">
            <!-- Introduction et documentation -->
            <section class="panel panel-intro" id="intro">
                <h1 id="intro">Bienvenue sur le panneau de contr√¥le du robot Go2</h1>
                <p>
                    Cette interface web vous permet de piloter et surveiller en temps r√©el un robot quadrup√®de <b>Go2 (Unitree Robotics)</b>.<br>
                    <ul>
                        <li><b>Envoyer des commandes</b> pr√©d√©finies ou personnalis√©es au robot</li>
                        <li><b>Contr√¥ler la direction</b> gr√¢ce au joystick ou au clavier</li>
                        <li><b>Visualiser sa position, orientation, vitesse et batterie</b> en direct</li>
                        <li><b>Tracer et envoyer un chemin</b> sur la carte</li>
                        <li><b>Voir le flux vid√©o</b> embarqu√©</li>
                    </ul>
                    <em>Utilisez le menu √† gauche ou faites d√©filer pour explorer toutes les fonctionnalit√©s.</em>
                </p>
                <p class="section-desc" style="margin-top:1em;font-size:0.95em;color:#888;">
                    <b>Architecture technique :</b> L‚ÄôAPI web s‚Äôappuie sur Flask (Python), MQTT pour la communication temps r√©el, Leaflet pour la cartographie, et NippleJS pour le joystick.<br>
                    <a href="#doc-archi" style="color:var(--accent);text-decoration:underline;">Voir le sch√©ma d‚Äôarchitecture</a>
                </p>
            </section>

            <!-- Commandes rapides -->
            <section class="panel panel-control" id="control">
                <h2>Commandes rapides</h2>
                <p class="section-desc">
                    S√©lectionnez une commande dans la liste pour l‚Äôenvoyer instantan√©ment au robot Go2.<br>
                    Ces commandes couvrent les postures, la locomotion, les danses, et divers modes sp√©ciaux.<br>
                    <em>Le robot confirme chaque commande re√ßue via MQTT.</em>
                </p>
                <form method="post" id="command-form">
                    <select name="command" id="command" required>
                        <option value="" disabled selected>-- S√©lectionnez une commande --</option>
                        <!-- ... toutes les options ... -->
                        <option value="Damp">Damp</option>
                        <option value="BalanceStand">BalanceStand</option>
                        <option value="StopMove">StopMove</option>
                        <option value="StandUp">StandUp</option>
                        <option value="StandDown">StandDown</option>
                        <option value="RecoveryStand">RecoveryStand</option>
                        <option value="Euler">Euler</option>
                        <option value="Move">Move</option>
                        <option value="Sit">Sit</option>
                        <option value="RiseSit">RiseSit</option>
                        <option value="SwitchGait">SwitchGait</option>
                        <option value="Trigger">Trigger</option>
                        <option value="BodyHeight">BodyHeight</option>
                        <option value="FootRaiseHeight">FootRaiseHeight</option>
                        <option value="SpeedLevel">SpeedLevel</option>
                        <option value="Hello">Hello</option>
                        <option value="Stretch">Stretch</option>
                        <option value="TrajectoryFollow">TrajectoryFollow</option>
                        <option value="ContinuousGait">ContinuousGait</option>
                        <option value="Content">Content</option>
                        <option value="Wallow">Wallow</option>
                        <option value="Dance1">Dance1</option>
                        <option value="Dance2">Dance2</option>
                        <option value="GetBodyHeight">GetBodyHeight</option>
                        <option value="GetFootRaiseHeight">GetFootRaiseHeight</option>
                        <option value="GetSpeedLevel">GetSpeedLevel</option>
                        <option value="SwitchJoystick">SwitchJoystick</option>
                        <option value="Pose">Pose</option>
                        <option value="Scrape">Scrape</option>
                        <option value="FrontFlip">FrontFlip</option>
                        <option value="FrontJump">FrontJump</option>
                        <option value="FrontPounce">FrontPounce</option>
                        <option value="WiggleHips">WiggleHips</option>
                        <option value="GetState">GetState</option>
                        <option value="EconomicGait">EconomicGait</option>
                        <option value="FingerHeart">FingerHeart</option>
                    </select>
                    <button type="submit">Envoyer</button>
                </form>
                <p class="section-desc">
                    <b>Tableau de bord temps r√©el :</b> affiche la position GPS, l‚Äôorientation (boussole), la vitesse instantan√©e, la distance parcourue, l‚Äô√©tat courant, le niveau de batterie et le statut g√©n√©ral du robot.
                </p>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="label">Position</span>
                        <span id="coords-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Orientation</span>
                        <span id="yaw-value">0¬∞</span>
                        <span id="compass-arrow" class="compass-arrow" style="transform: rotate(0deg);">üß≠</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Vitesse</span>
                        <span id="speed-value">0.00</span> m/s
                    </div>
                    <div class="status-item">
                        <span class="label">Distance</span>
                        <span id="distance-value">0.00</span> <span id="distance-unit">m</span>
                        <button onclick="resetDistance()" class="reset-btn" title="R√©initialiser">‚Ü∫</button>
                    </div>
                    <div class="status-item">
                        <span class="label">√âtat</span>
                        <span id="state-mode">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Batterie</span>
                        <span id="state-battery">--</span> %
                    </div>
                    <div class="status-item">
                        <span class="label">Statut</span>
                        <span id="state-status">--</span>
                    </div>
                </div>
            </section>

            <!-- Contr√¥les directionnels -->
            <section class="panel">
                <h2>Contr√¥les directionnels</h2>
                <p class="section-desc">
                    <b>Joystick :</b> Faites glisser le joystick pour orienter le robot en douceur.<br>
                    <b>Clavier :</b> Utilisez les touches <b>‚Üë</b> et <b>‚Üì</b> pour avancer/reculer, <b>‚Üê</b> et <b>‚Üí</b> pour tourner.<br>
                    <em>Les boutons STOP/PAUSE permettent d‚Äôarr√™ter ou de mettre en pause le robot imm√©diatement.</em>
                </p>
                <div class="control-section">
                    <div class="joystick-container">
                        <div class="joystick-label">Joystick directionnel</div>
                        <div id="joystick-direction"></div>
                        <div class="hint-text">Glissez pour contr√¥ler la direction</div>
                    </div>
                    
                    <div class="keyboard-controls">
                        <div class="keyboard-label">Contr√¥les clavier</div>
                        <div class="arrow-grid">
                            <div class="arrow-key up">‚Üë</div>
                            <div class="arrow-key left">‚Üê</div>
                            <div class="arrow-key down">‚Üì</div>
                            <div class="arrow-key right">‚Üí</div>
                        </div>
                        <div class="hint-text">Utilisez les fl√®ches pour avancer/reculer/tourner</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-action btn-stop" onclick="robotStop()">STOP</button>
                    <button class="btn-action btn-pause" onclick="robotPause()">PAUSE</button>
                </div>
            </section>

            <!-- Carte & Trajet -->
            <section class="panel panel-map" id="map-section">
                <h2>Carte & Trajet</h2>
                <p class="section-desc">
                    Visualisez la position du robot sur la carte en temps r√©el.<br>
                    Tracez un chemin √† la souris, puis envoyez-le au robot pour une navigation autonome.<br>
                    <em>Le trac√© rouge montre le parcours r√©el du robot, le trac√© vert le chemin programm√©.</em>
                </p>
                <div class="map-actions">
                    <button id="toggle-drawing" onclick="toggleDrawing()">Activer le trac√©</button>
                    <button id="send-path" onclick="sendPath()" disabled>Envoyer le chemin</button>
                    <button id="clear-path" onclick="clearPath()" disabled>Effacer le trac√©</button>
                </div>
                <div id="map"></div>
            </section>

            <!-- Vid√©o -->
            <section class="panel panel-video" id="video">
                <h2>Flux vid√©o du robot</h2>
                <p class="section-desc">
                    Suivez le flux vid√©o embarqu√© du robot Go2 pour surveiller son environnement et ses d√©placements en direct.<br>
                    <em>Le flux est transmis en MJPEG ou HLS selon la configuration mat√©rielle.</em>
                </p>
                <img id="robot-video" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='480' height='360' viewBox='0 0 480 360'><rect width='100%' height='100%' fill='%23000'/><text x='50%' y='50%' text-anchor='middle' fill='white' font-size='24'>Flux vid√©o en cours...</text></svg>" alt="Flux vid√©o du robot Go2"/>
            </section>

            <!-- Architecture technique -->
            <section id="doc-archi" class="panel panel-archi">
                <h2 id="doc-archi">Architecture technique de l‚ÄôAPI Web Go2</h2>
                <p>
                    <b>Explications :</b><br>
                    <ul>
                        <li><b>Flask</b> sert l‚Äôinterface web et fait le lien entre l‚Äôutilisateur et le robot via MQTT.</li>
                        <li><b>MQTT</b> assure la communication temps r√©el‚ÄØ: commandes, retours d‚Äô√©tat, accus√©s de r√©ception.</li>
                        <li><b>Leaflet</b> affiche la carte et le trac√© du robot.</li>
                        <li><b>NippleJS</b> g√®re le joystick virtuel pour la direction.</li>
                        <li><b>OpenCV</b> ou un flux IP fournit la vid√©o embarqu√©e.</li>
                    </ul>
                </p>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
    <script>
        // Gestion du th√®me
        document.addEventListener("DOMContentLoaded", function() {
            const toggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
                toggle.checked = true;
            }
            
            toggle.addEventListener('change', function() {
                if (this.checked) {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
        });

        // Initialisation de la carte
        const pathCoords = [
            [48.777164396, 2.375696799],
            [48.777266135, 2.375488087],
            [48.777245920, 2.375302510],
            [48.777219946, 2.374943893]
        ];

        const map = L.map('map').setView(pathCoords[0], 19);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 22,
        }).addTo(map);

        // Initialisation du joystick
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick-direction'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: '#007bff',
            size: 140
        });

        joystick.on('move', function (evt, data) {
            if (data && data.direction) {
                console.log('Joystick:', data.angle.degree, data.direction.angle);
                // Ici vous pouvez envoyer les commandes au robot
            }
        });

        joystick.on('end', function () {
            console.log('Joystick arr√™t√©');
            // Arr√™ter le mouvement du robot
        });

        // Gestion des touches du clavier
        let activeKeys = new Set();

        document.addEventListener('keydown', function(e) {
            if (e.repeat) return;
            
            const key = e.key;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                e.preventDefault();
                activeKeys.add(key);
                
                // Visual feedback
                const keyMap = {
                    'ArrowUp': 'up',
                    'ArrowDown': 'down', 
                    'ArrowLeft': 'left',
                    'ArrowRight': 'right'
                };
                
                const element = document.querySelector(`.arrow-key.${keyMap[key]}`);
                if (element) {
                    element.style.background = 'var(--accent)';
                    element.style.color = 'white';
                }
                
                console.log('Touche press√©e:', key);
                // Envoyer commande au robot
            }
        });

        document.addEventListener('keyup', function(e) {
            const key = e.key;
            if (activeKeys.has(key)) {
                activeKeys.delete(key);
                
                // Remove visual feedback
                const keyMap = {
                    'ArrowUp': 'up',
                    'ArrowDown': 'down',
                    'ArrowLeft': 'left', 
                    'ArrowRight': 'right'
                };
                
                const element = document.querySelector(`.arrow-key.${keyMap[key]}`);
                if (element) {
                    element.style.background = '';
                    element.style.color = '';
                }
                
                console.log('Touche rel√¢ch√©e:', key);
                // Arr√™ter commande au robot
            }
        });

        // Fonctions de contr√¥le
        function robotStop() {
            console.log('Robot STOP');
            alert('Commande STOP envoy√©e au robot');
        }

        function robotPause() {
            console.log('Robot PAUSE');
            alert('Commande PAUSE envoy√©e au robot');
        }

        function resetDistance() {
            document.getElementById('distance-value').textContent = '0.00';
            document.getElementById('distance-unit').textContent = 'm';
        }

        // Variables pour le trac√© de chemin
        let drawingPath = false;
        let newPathCoords = [];
        let newPathLine = null;

        function toggleDrawing() {
            drawingPath = !drawingPath;
            document.getElementById('toggle-drawing').textContent = drawingPath ? "Arr√™ter le trac√©" : "Activer le trac√©";
            document.getElementById('send-path').disabled = !drawingPath;
            document.getElementById('clear-path').disabled = !drawingPath;
        }

        function sendPath() {
            if (newPathCoords.length < 2) {
                alert("Tracez au moins deux points !");
                return;
            }
            console.log('Chemin envoy√©:', newPathCoords);
            alert("Chemin envoy√© au robot !");
            toggleDrawing();
        }

        function clearPath() {
            newPathCoords = [];
            if (newPathLine) {
                map.removeLayer(newPathLine);
                newPathLine = null;
            }
        }

        map.on('click', function(e) {
            if (drawingPath) {
                newPathCoords.push([e.latlng.lat, e.latlng.lng]);
                if (newPathLine) {
                    newPathLine.setLatLngs(newPathCoords);
                } else {
                    newPathLine = L.polyline(newPathCoords, {color: 'green', weight: 4, dashArray: '5,10'}).addTo(map);
                }
            }
        });

        // Simulation de mise √† jour des donn√©es
        setInterval(function() {
            const battery = Math.floor(Math.random() * 30) + 70;
            const speed = (Math.random() * 2).toFixed(2);
            document.getElementById('header-battery-val').textContent = battery;
            document.getElementById('speed-value').textContent = speed;
        }, 3000);

        document.querySelectorAll('nav a[href^="#"]').forEach(link => {
            link.addEventListener('click', function(e) {
                const targetId = this.getAttribute('href').replace('#', '');
                const target = document.getElementById(targetId);
                if (target) {
                    e.preventDefault();
                    target.scrollIntoView({ behavior: 'smooth' });
                    setTimeout(() => target.focus(), 600); // met le focus apr√®s le scroll
                }
            });
        });

    </script>
</body>
</html>