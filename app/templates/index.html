<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Go2 Robot Control</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/nipplejs@0.9.0/dist/nipplejs.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <header>
        <div class="brand">
            <div class="logo">ü§ñ</div>
            <span>Go2 Control Panel</span>
        </div>
        <div class="theme-switch">
            <input type="checkbox" id="theme-toggle" />
            <label for="theme-toggle" class="slider"></label>
        </div>
        <div class="robot-status-header">
            <span id="header-state">√âtat : <span id="header-state-val">...</span></span>
            <span id="header-battery">üîã <span id="header-battery-val">...</span>%</span>
        </div>
    </header>

    <nav>
        <ul>
            <li class="active"><a href="#control">Contr√¥le</a></li>
            <li><a href="#map-section">Carte</a></li>
            <li><a href="#video">Vid√©o</a></li>
        </ul>
    </nav>

    <main>
        <div class="container">
            <section class="panel panel-control" id="control">
                <h2>Commandes rapides</h2>
                <form method="post" id="command-form">
                    <select name="command" id="command" required>
                        <option value="" disabled selected>-- S√©lectionnez une commande --</option>
                        <option value="Damp">Damp</option>
                        <option value="BalanceStand">BalanceStand</option>
                        <option value="StopMove">StopMove</option>
                        <option value="StandUp">StandUp</option>
                        <option value="StandDown">StandDown</option>
                        <option value="RecoveryStand">RecoveryStand</option>
                        <option value="Euler">Euler</option>
                        <option value="Move">Move</option>
                        <option value="Sit">Sit</option>
                        <option value="RiseSit">RiseSit</option>
                        <option value="SwitchGait">SwitchGait</option>
                        <option value="Trigger">Trigger</option>
                        <option value="BodyHeight">BodyHeight</option>
                        <option value="FootRaiseHeight">FootRaiseHeight</option>
                        <option value="SpeedLevel">SpeedLevel</option>
                        <option value="Hello">Hello</option>
                        <option value="Stretch">Stretch</option>
                        <option value="TrajectoryFollow">TrajectoryFollow</option>
                        <option value="ContinuousGait">ContinuousGait</option>
                        <option value="Content">Content</option>
                        <option value="Wallow">Wallow</option>
                        <option value="Dance1">Dance1</option>
                        <option value="Dance2">Dance2</option>
                        <option value="GetBodyHeight">GetBodyHeight</option>
                        <option value="GetFootRaiseHeight">GetFootRaiseHeight</option>
                        <option value="GetSpeedLevel">GetSpeedLevel</option>
                        <option value="SwitchJoystick">SwitchJoystick</option>
                        <option value="Pose">Pose</option>
                        <option value="Scrape">Scrape</option>
                        <option value="FrontFlip">FrontFlip</option>
                        <option value="FrontJump">FrontJump</option>
                        <option value="FrontPounce">FrontPounce</option>
                        <option value="WiggleHips">WiggleHips</option>
                        <option value="GetState">GetState</option>
                        <option value="EconomicGait">EconomicGait</option>
                        <option value="FingerHeart">FingerHeart</option>
                    </select>
                    <button type="submit">Envoyer</button>
                </form>

                <div class="status-grid">
                    <div class="status-item">
                        <span class="label">Position</span>
                        <span id="coords-value">48.777164, 2.375697</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Orientation</span>
                        <span id="yaw-value">45¬∞</span>
                        <span id="compass-arrow" class="compass-arrow" style="transform: rotate(45deg);">üß≠</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Vitesse</span>
                        <span id="speed-value">1.23</span> m/s
                    </div>
                    <div class="status-item">
                        <span class="label">Distance</span>
                        <span id="distance-value">127.5</span> <span id="distance-unit">m</span>
                        <button onclick="resetDistance()" class="reset-btn" title="R√©initialiser">‚Ü∫</button>
                    </div>
                    <div class="status-item">
                        <span class="label">√âtat</span>
                        <span id="state-mode">En mouvement</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Batterie</span>
                        <span id="state-battery">87</span> %
                    </div>
                </div>
            </section>

            <section class="panel">
                <h2>Contr√¥les directionnels</h2>
                <div class="control-section">
                    <div class="joystick-container">
                        <div class="joystick-label">Joystick directionnel</div>
                        <div id="joystick-direction"></div>
                        <div class="hint-text">Glissez pour contr√¥ler la direction</div>
                    </div>
                    
                    <div class="keyboard-controls">
                        <div class="keyboard-label">Contr√¥les clavier</div>
                        <div class="arrow-grid">
                            <div class="arrow-key up">‚Üë</div>
                            <div class="arrow-key left">‚Üê</div>
                            <div class="arrow-key down">‚Üì</div>
                            <div class="arrow-key right">‚Üí</div>
                        </div>
                        <div class="hint-text">Utilisez les fl√®ches pour avancer/reculer/tourner</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-action btn-stop" onclick="robotStop()">STOP</button>
                    <button class="btn-action btn-pause" onclick="robotPause()">PAUSE</button>
                </div>
            </section>

            <section class="panel panel-map" id="map-section">
                <h2>Carte & Trajet</h2>
                <div class="map-actions">
                    <button id="toggle-drawing" onclick="toggleDrawing()">Activer le trac√©</button>
                    <button id="send-path" onclick="sendPath()" disabled>Envoyer le chemin</button>
                    <button id="clear-path" onclick="clearPath()" disabled>Effacer le trac√©</button>
                </div>
                <div id="map"></div>
            </section>

            <section class="panel panel-video" id="video">
                <h2>Flux vid√©o du robot</h2>
                <img id="robot-video" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='480' height='360' viewBox='0 0 480 360'><rect width='100%' height='100%' fill='%23000'/><text x='50%' y='50%' text-anchor='middle' fill='white' font-size='24'>Flux vid√©o en cours...</text></svg>" alt="Flux vid√©o du robot Go2"/>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
    <script>
        // Gestion du th√®me
        document.addEventListener("DOMContentLoaded", function() {
            const toggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
                toggle.checked = true;
            }
            
            toggle.addEventListener('change', function() {
                if (this.checked) {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
        });

        // Initialisation de la carte
        const pathCoords = [
            [48.777164396, 2.375696799],
            [48.777266135, 2.375488087],
            [48.777245920, 2.375302510],
            [48.777219946, 2.374943893]
        ];

        const map = L.map('map').setView(pathCoords[0], 19);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 22,
        }).addTo(map);

        // Initialisation du joystick
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick-direction'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: '#007bff',
            size: 140
        });

        joystick.on('move', function (evt, data) {
            if (data && data.direction) {
                console.log('Joystick:', data.angle.degree, data.direction.angle);
                // Ici vous pouvez envoyer les commandes au robot
            }
        });

        joystick.on('end', function () {
            console.log('Joystick arr√™t√©');
            // Arr√™ter le mouvement du robot
        });

        // Gestion des touches du clavier
        let activeKeys = new Set();

        document.addEventListener('keydown', function(e) {
            if (e.repeat) return;
            
            const key = e.key;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                e.preventDefault();
                activeKeys.add(key);
                
                // Visual feedback
                const keyMap = {
                    'ArrowUp': 'up',
                    'ArrowDown': 'down', 
                    'ArrowLeft': 'left',
                    'ArrowRight': 'right'
                };
                
                const element = document.querySelector(`.arrow-key.${keyMap[key]}`);
                if (element) {
                    element.style.background = 'var(--accent)';
                    element.style.color = 'white';
                }
                
                console.log('Touche press√©e:', key);
                // Envoyer commande au robot
            }
        });

        document.addEventListener('keyup', function(e) {
            const key = e.key;
            if (activeKeys.has(key)) {
                activeKeys.delete(key);
                
                // Remove visual feedback
                const keyMap = {
                    'ArrowUp': 'up',
                    'ArrowDown': 'down',
                    'ArrowLeft': 'left', 
                    'ArrowRight': 'right'
                };
                
                const element = document.querySelector(`.arrow-key.${keyMap[key]}`);
                if (element) {
                    element.style.background = '';
                    element.style.color = '';
                }
                
                console.log('Touche rel√¢ch√©e:', key);
                // Arr√™ter commande au robot
            }
        });

        // Fonctions de contr√¥le
        function robotStop() {
            console.log('Robot STOP');
            alert('Commande STOP envoy√©e au robot');
        }

        function robotPause() {
            console.log('Robot PAUSE');
            alert('Commande PAUSE envoy√©e au robot');
        }

        function resetDistance() {
            document.getElementById('distance-value').textContent = '0.00';
            document.getElementById('distance-unit').textContent = 'm';
        }

        // Variables pour le trac√© de chemin
        let drawingPath = false;
        let newPathCoords = [];
        let newPathLine = null;

        function toggleDrawing() {
            drawingPath = !drawingPath;
            document.getElementById('toggle-drawing').textContent = drawingPath ? "Arr√™ter le trac√©" : "Activer le trac√©";
            document.getElementById('send-path').disabled = !drawingPath;
            document.getElementById('clear-path').disabled = !drawingPath;
        }

        function sendPath() {
            if (newPathCoords.length < 2) {
                alert("Tracez au moins deux points !");
                return;
            }
            console.log('Chemin envoy√©:', newPathCoords);
            alert("Chemin envoy√© au robot !");
            toggleDrawing();
        }

        function clearPath() {
            newPathCoords = [];
            if (newPathLine) {
                map.removeLayer(newPathLine);
                newPathLine = null;
            }
        }

        map.on('click', function(e) {
            if (drawingPath) {
                newPathCoords.push([e.latlng.lat, e.latlng.lng]);
                if (newPathLine) {
                    newPathLine.setLatLngs(newPathCoords);
                } else {
                    newPathLine = L.polyline(newPathCoords, {color: 'green', weight: 4, dashArray: '5,10'}).addTo(map);
                }
            }
        });

        // Simulation de mise √† jour des donn√©es
        setInterval(function() {
            const battery = Math.floor(Math.random() * 30) + 70;
            const speed = (Math.random() * 2).toFixed(2);
            document.getElementById('header-battery-val').textContent = battery;
            document.getElementById('speed-value').textContent = speed;
        }, 3000);
    </script>
</body>
</html>